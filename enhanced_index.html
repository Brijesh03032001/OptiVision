<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OptiVision - Optimized Vision AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- OptiVision Configuration -->
  <script src="js/config.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #00d4ff 0%, #0099cc 50%, #006699 100%);
      --secondary-gradient: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      --success-gradient: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
      --danger-gradient: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
      --bg-primary: #0a0e1a;
      --bg-card: rgba(255, 255, 255, 0.05);
      --text-primary: #ffffff;
      --text-secondary: #a0aec0;
      --border-color: rgba(0, 212, 255, 0.2);
      --shadow-sm: 0 1px 3px rgba(0, 212, 255, 0.1);
      --shadow-md: 0 4px 15px rgba(0, 212, 255, 0.15);
      --shadow-lg: 0 10px 30px rgba(0, 212, 255, 0.2);
      --border-radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 153, 204, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(0, 255, 136, 0.2) 0%, transparent 50%),
        linear-gradient(45deg, #0a0e1a 0%, #1a1f2e 50%, #0f1419 100%);
      min-height: 100vh;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeIn 0.8s ease-out;
      position: relative;
      overflow-x: hidden;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
      animation: slideDown 0.8s ease-out 0.2s both;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
    }

    .header .subtitle {
      font-size: 1.2rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .main-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      max-width: 1200px;
      width: 100%;
      animation: slideUp 0.8s ease-out 0.4s both;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .video-section {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
    }

    .video-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .media-container {
      position: relative;
      margin-bottom: 1.5rem;
      border-radius: 12px;
      overflow: hidden;
      background: linear-gradient(45deg, #000428, #004e92);
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .media-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        rgba(102, 126, 234, 0.1) 0%, 
        rgba(118, 75, 162, 0.1) 100%);
      z-index: 1;
    }

    video, img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 12px;
      transition: var(--transition);
    }

    .media-placeholder {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.1rem;
      text-align: center;
      z-index: 2;
    }

    .media-placeholder i {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
      opacity: 0.6;
    }

    canvas { 
      display: none; 
    }

    .controls-section {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
    }

    .controls-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 1.5rem;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-group label i {
      margin-right: 0.5rem;
      color: var(--text-secondary);
    }

    select, input, textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.8);
      transition: var(--transition);
      font-family: inherit;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      color: var(--text-secondary);
    }

    .file-input-label:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, #f8f9ff 0%, #e7ebff 100%);
      transform: translateY(-2px);
    }

    .file-input-label i {
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .btn {
      flex: 1;
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: var(--success-gradient);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
    }

    .btn-danger {
      background: var(--danger-gradient);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-danger:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(250, 112, 154, 0.3);
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 1rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .status-indicator.connected {
      background: rgba(34, 197, 94, 0.1);
      color: #059669;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .status-indicator.disconnected {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .status-indicator i {
      margin-right: 0.5rem;
    }

    .response-container {
      position: relative;
    }

    .response-container.loading::after {
      content: '';
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden-section {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .hidden-section.show {
      display: block;
    }

    .model-info {
      background: rgba(102, 126, 234, 0.05);
      border: 1px solid rgba(102, 126, 234, 0.1);
      border-radius: 8px;
      padding: 0.75rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .floating-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
      50% { transform: translateY(-100px) rotate(180deg); opacity: 1; }
    }

    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .header h1 {
        font-size: 2.5rem;
      }
      
      .button-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="floating-particles"></div>
  
  <div class="header">
    <h1><i class="fas fa-eye"></i> OptiVision</h1>
    <p class="subtitle">Advanced Optical Vision Intelligence</p>
  </div>

  <div class="main-container">
    <!-- Video/Image Display Section -->
    <div class="video-section">
      <div class="status-indicator connected">
        <i class="fas fa-circle"></i>
        <span id="connectionStatus">Ready</span>
      </div>
      
      <div class="media-container">
        <video id="videoFeed" autoplay muted playsinline style="display:none"></video>
        <img id="imagePreview" style="display:none" />
        <div class="media-placeholder" id="mediaPlaceholder">
          <i class="fas fa-video"></i>
          <div>Select a source to begin</div>
        </div>
      </div>
      <canvas id="canvas"></canvas>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
      <div class="form-group">
        <label for="sourceType">
          <i class="fas fa-camera"></i>
          Input Source
        </label>
        <select id="sourceType">
          <option value="webcam">📹 Webcam</option>
          <option value="video">🎬 Video File</option>
          <option value="image">🖼️ Image File</option>
        </select>
      </div>

      <div id="videoFileSection" class="form-group hidden-section">
        <label for="videoFile">
          <i class="fas fa-upload"></i>
          Upload Video
        </label>
        <div class="file-input-wrapper">
          <input type="file" id="videoFile" accept="video/*">
          <label for="videoFile" class="file-input-label">
            <i class="fas fa-cloud-upload-alt"></i>
            Choose video file
          </label>
        </div>
      </div>

      <div id="imageFileSection" class="form-group hidden-section">
        <label for="imageFile">
          <i class="fas fa-upload"></i>
          Upload Image
        </label>
        <div class="file-input-wrapper">
          <input type="file" id="imageFile" accept="image/*">
          <label for="imageFile" class="file-input-label">
            <i class="fas fa-cloud-upload-alt"></i>
            Choose image file
          </label>
        </div>
      </div>

      <div class="form-group">
        <label for="baseURL">
          <i class="fas fa-server"></i>
          API Endpoint
        </label>
        <input id="baseURL" value="" placeholder="API server URL (auto-detected)">
      </div>

      <div class="form-group">
        <label for="modelSelect">
          <i class="fas fa-brain"></i>
          AI Model
        </label>
        <select id="modelSelect">
          <option value="ggml-org/SmolVLM-Instruct-GGUF">SmolVLM Base</option>
          <option value="ggml-org/SmolVLM-256M-Instruct-GGUF">SmolVLM-256M</option>
          <option value="ggml-org/SmolVLM-500M-Instruct-GGUF" selected>SmolVLM-500M</option>
          <option value="ggml-org/SmolVLM2-2.2B-Instruct-GGUF">SmolVLM2-2.2B</option>
          <option value="ggml-org/SmolVLM2-256M-Video-Instruct-GGUF">SmolVLM2-256M-Video</option>
          <option value="ggml-org/SmolVLM2-500M-Video-Instruct-GGUF">SmolVLM2-500M-Video</option>
        </select>
        <div class="model-info">
          Selected: SmolVLM-500M (Optimized for general vision tasks)
        </div>
      </div>

      <div class="form-group">
        <label for="instructionText">
          <i class="fas fa-comment-dots"></i>
          Your Question
        </label>
        <textarea id="instructionText" placeholder="What would you like to know about the image?">What do you see?</textarea>
      </div>

      <div class="form-group">
        <label for="responseText">
          <i class="fas fa-robot"></i>
          AI Response
        </label>
        <div class="response-container" id="responseContainer">
          <textarea id="responseText" readonly placeholder="AI response will appear here..."></textarea>
        </div>
      </div>

      <div class="form-group">
        <label for="intervalSelect">
          <i class="fas fa-clock"></i>
          Capture Interval
        </label>
        <select id="intervalSelect">
          <option value="100">⚡ 100ms - Ultra Fast</option>
          <option value="250">🚀 250ms - Fast</option>
          <option value="500" selected>⚖️ 500ms - Balanced</option>
          <option value="1000">🐢 1s - Slow</option>
          <option value="2000">🕰️ 2s - Very Slow</option>
        </select>
      </div>

      <div class="button-group">
        <button id="startButton" class="btn btn-primary">
          <i class="fas fa-play"></i>
          Start Analysis
        </button>
      </div>
    </div>
  </div>

  <script>
    // Create floating particles
    function createParticles() {
      const container = document.querySelector('.floating-particles');
      for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
        container.appendChild(particle);
      }
    }
    createParticles();

    // Main application logic
    const video = document.getElementById('videoFeed');
    const imagePreview = document.getElementById('imagePreview');
    const canvas = document.getElementById('canvas');
    const baseURL = document.getElementById('baseURL');
    const instructionText = document.getElementById('instructionText');
    const responseText = document.getElementById('responseText');
    const intervalSelect = document.getElementById('intervalSelect');
    const startButton = document.getElementById('startButton');
    const modelSelect = document.getElementById('modelSelect');
    const sourceType = document.getElementById('sourceType');
    const videoFileInput = document.getElementById('videoFile');
    const imageFileInput = document.getElementById('imageFile');
    const videoFileSection = document.getElementById('videoFileSection');
    const imageFileSection = document.getElementById('imageFileSection');
    const mediaPlaceholder = document.getElementById('mediaPlaceholder');
    const connectionStatus = document.getElementById('connectionStatus');
    const responseContainer = document.getElementById('responseContainer');

    let stream;
    let intervalId;
    let isProcessing = false;
    let imageDataURL = null;

    // Update model info
    modelSelect.addEventListener('change', () => {
      const modelInfo = document.querySelector('.model-info');
      const selectedOption = modelSelect.options[modelSelect.selectedIndex];
      modelInfo.textContent = `Selected: ${selectedOption.text}`;
      baseURL.value = `${OptiVisionConfig.getApiUrl()}?model=${modelSelect.value}`;
    });

    // Handle source type changes
    sourceType.addEventListener('change', () => {
      stopStream();
      hideAllMedia();
      
      // Hide all file sections
      videoFileSection.classList.remove('show');
      imageFileSection.classList.remove('show');
      
      setTimeout(() => {
        switch (sourceType.value) {
          case 'webcam':
            mediaPlaceholder.innerHTML = '<i class="fas fa-video"></i><div>Initializing webcam...</div>';
            initWebcam();
            break;
          case 'video':
            videoFileSection.classList.add('show');
            mediaPlaceholder.innerHTML = '<i class="fas fa-film"></i><div>Select a video file</div>';
            break;
          case 'image':
            imageFileSection.classList.add('show');
            mediaPlaceholder.innerHTML = '<i class="fas fa-image"></i><div>Select an image file</div>';
            break;
        }
      }, 300);
    });

    function hideAllMedia() {
      video.style.display = 'none';
      imagePreview.style.display = 'none';
      mediaPlaceholder.style.display = 'block';
    }

    function showMedia(element) {
      hideAllMedia();
      element.style.display = 'block';
      mediaPlaceholder.style.display = 'none';
    }

    // File input handlers
    videoFileInput.addEventListener('change', () => {
      const file = videoFileInput.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        video.srcObject = null;
        video.src = url;
        video.load();
        video.play();
        showMedia(video);
        updateStatus("Video loaded successfully", "connected");
        
        // Update file label
        const label = document.querySelector('label[for="videoFile"]');
        label.innerHTML = `<i class="fas fa-check"></i>Video loaded: ${file.name}`;
      }
    });

    imageFileInput.addEventListener('change', () => {
      const file = imageFileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          imageDataURL = e.target.result;
          imagePreview.src = imageDataURL;
          showMedia(imagePreview);
          updateStatus("Image loaded successfully", "connected");
          
          // Update file label
          const label = document.querySelector('label[for="imageFile"]');
          label.innerHTML = `<i class="fas fa-check"></i>Image loaded: ${file.name}`;
        };
        reader.readAsDataURL(file);
      }
    });

    async function initWebcam() {
      try {
        updateStatus("Requesting camera access...", "disconnected");
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 640 }, 
            height: { ideal: 480 } 
          } 
        });
        video.srcObject = stream;
        showMedia(video);
        updateStatus("Webcam connected", "connected");
      } catch (err) {
        console.error("Camera error:", err);
        updateStatus(`Camera error: ${err.message}`, "disconnected");
        mediaPlaceholder.innerHTML = '<i class="fas fa-exclamation-triangle"></i><div>Camera access denied</div>';
      }
    }

    function stopStream() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    function updateStatus(message, type) {
      connectionStatus.textContent = message;
      const indicator = document.querySelector('.status-indicator');
      indicator.className = `status-indicator ${type}`;
    }

    function captureImage() {
      if (sourceType.value === 'image') {
        return imageDataURL;
      }
      if (!video.videoWidth) return null;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      return canvas.toDataURL('image/jpeg', 0.8);
    }

    async function sendChatCompletionRequest(instruction, imageBase64URL) {
      responseContainer.classList.add('loading');
      
      const response = await fetch(`${baseURL.value}/v1/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          max_tokens: 150,
          messages: [{
            role: 'user',
            content: [
              { type: 'text', text: instruction },
              { type: 'image_url', image_url: { url: imageBase64URL } }
            ]
          }]
        })
      });

      responseContainer.classList.remove('loading');

      if (!response.ok) {
        const err = await response.text();
        throw new Error(`Server error: ${response.status} - ${err}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    async function sendData() {
      if (!isProcessing) return;
      
      const image = captureImage();
      if (!image) {
        responseText.value = "❌ Image capture failed.";
        return;
      }

      try {
        updateStatus("Processing...", "disconnected");
        const reply = await sendChatCompletionRequest(instructionText.value, image);
        responseText.value = "🤖 " + reply;
        updateStatus("Analysis complete", "connected");
      } catch (err) {
        responseText.value = `❌ Error: ${err.message}`;
        updateStatus("Error occurred", "disconnected");
      }
    }

    function handleStart() {
      if (sourceType.value !== 'image' && !video.srcObject && !video.src) {
        alert("⚠️ No video source available. Please select a source first.");
        return;
      }
      if (sourceType.value === 'image' && !imageDataURL) {
        alert("⚠️ No image loaded. Please select an image first.");
        return;
      }

      isProcessing = true;
      startButton.innerHTML = '<i class="fas fa-stop"></i> Stop Analysis';
      startButton.classList.remove('btn-primary');
      startButton.classList.add('btn-danger');
      updateStatus("Analysis started", "connected");

      sendData();
      if (sourceType.value !== 'image') {
        intervalId = setInterval(sendData, parseInt(intervalSelect.value, 10));
      }
    }

    function handleStop() {
      isProcessing = false;
      clearInterval(intervalId);
      intervalId = null;
      startButton.innerHTML = '<i class="fas fa-play"></i> Start Analysis';
      startButton.classList.remove('btn-danger');
      startButton.classList.add('btn-primary');
      updateStatus("Analysis stopped", "connected");
    }

    startButton.addEventListener('click', () => {
      isProcessing ? handleStop() : handleStart();
    });

    // Initialize webcam on load
    window.addEventListener('DOMContentLoaded', async () => {
      // Initialize API URL
      baseURL.value = OptiVisionConfig.getApiUrl();
      
      // Check backend availability
      const backendAvailable = await OptiVisionConfig.checkBackend();
      if (!backendAvailable) {
        console.warn('Backend not available, some features may not work');
        // You could show a warning message to the user here
      }
      
      setTimeout(() => {
        initWebcam();
      }, 500);
    });

    window.addEventListener('beforeunload', () => {
      stopStream();
      clearInterval(intervalId);
    });

    // Add smooth scrolling and other enhancements
    document.querySelectorAll('select, input, textarea').forEach(element => {
      element.addEventListener('focus', function() {
        this.parentElement.style.transform = 'scale(1.02)';
      });
      
      element.addEventListener('blur', function() {
        this.parentElement.style.transform = 'scale(1)';
      });
    });
  </script>
</body>
</html>
